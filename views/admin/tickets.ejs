<%- include('header', { title: title, active: 'tickets' }) %>

    <div class="page-header">
        <h1 class="page-title">üéüÔ∏è Manage Tickets</h1>
    </div>

    <!-- Filters -->
    <form method="GET" class="filters-bar">
        <div class="form-group">
            <input type="text" name="search" placeholder="Search QR, phone, name..."
                value="<%= filters.search || '' %>">
        </div>
        <div class="form-group">
            <select name="status">
                <option value="">All Statuses</option>
                <option value="PAID" <%=filters.status==='PAID' ? 'selected' : '' %>>Paid</option>
                <option value="PENDING" <%=filters.status==='PENDING' ? 'selected' : '' %>>Pending
                </option>
                <option value="FAILED" <%=filters.status==='FAILED' ? 'selected' : '' %>>Failed
                </option>
            </select>
        </div>
        <div class="form-group">
            <select name="match_id">
                <option value="">All Matches</option>
                <% matches.forEach(function(m) { %>
                    <option value="<%= m.id %>" <%=filters.match_id===m.id ? 'selected' : '' %>>
                        <%= m.team_home %> vs <%= m.team_away %>
                    </option>
                    <% }); %>
            </select>
        </div>
        <button type="submit" class="btn-admin btn-admin-primary btn-admin-sm">Filter</button>
        <a href="/admin/tickets" class="btn-admin btn-admin-secondary btn-admin-sm">Clear</a>
    </form>

    <div class="admin-table-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>eSewa Ref</th>
                    <th>Match</th>
                    <th>Customer</th>
                    <th>Qty</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Used</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% if (tickets.length===0) { %>
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--admin-text-muted);">
                            No tickets found</td>
                    </tr>
                    <% } else { %>
                        <% tickets.forEach(function(t) { %>
                            <tr>
                                <td data-label="eSewa Ref">
                                    <code
                                        style="color: #f59e0b; font-size: 0.75rem;"><%= t.esewa_transaction_id || '‚Äî' %></code>
                                </td>
                                <td data-label="Match">
                                    <%= t.team_home %> vs <%= t.team_away %>
                                </td>
                                <td data-label="Customer">
                                    <%= t.user_name || 'Guest' %><br>
                                        <small style="color: var(--admin-text-muted);">
                                            <%= t.user_phone || '' %>
                                        </small>
                                </td>
                                <td data-label="Qty">
                                    <%= t.quantity %>
                                </td>
                                <td data-label="Amount">Rs. <%= Number(t.total_amount).toLocaleString() %>
                                </td>
                                <td data-label="Status">
                                    <% if (t.status==='PAID' ) { %>
                                        <span class="badge badge-success">Paid</span>
                                        <% } else if (t.status==='PENDING' ) { %>
                                            <span class="badge badge-warning">Pending</span>
                                            <% } else { %>
                                                <span class="badge badge-danger">
                                                    <%= t.status %>
                                                </span>
                                                <% } %>
                                </td>
                                <td data-label="Used">
                                    <% if (t.used_at) { %>
                                        <span class="badge badge-info">Used</span>
                                        <% } else { %>
                                            ‚Äî
                                            <% } %>
                                </td>
                                <td data-label="Actions">
                                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; width: 100%;">
                                        <% if (t.status==='PENDING' ) { %>
                                            <form action="/admin/tickets/<%= t.id %>/approve" method="POST"
                                                style="display: inline;">
                                                <button type="submit" class="btn-admin btn-admin-sm btn-admin-primary">‚úì
                                                    Approve</button>
                                            </form>
                                            <form action="/admin/tickets/<%= t.id %>/reject" method="POST"
                                                style="display: inline;">
                                                <button type="submit"
                                                    class="btn-admin btn-admin-sm btn-admin-danger">‚úó</button>
                                            </form>
                                            <% } else if (t.status==='PAID' && !t.used_at) { %>
                                                <form action="/admin/tickets/<%= t.id %>/mark-used" method="POST"
                                                    style="display: inline;">
                                                    <button type="submit"
                                                        class="btn-admin btn-admin-sm btn-admin-secondary">Mark
                                                        Used</button>
                                                </form>
                                                <% } else { %>
                                                    <span>‚Äî</span>
                                                    <% } %>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                                <% } %>
            </tbody>
        </table>
    </div>

    <p style="margin-top: 1rem; color: var(--admin-text-muted); font-size: 0.875rem;">
        Showing <%= tickets.length %> ticket(s)
    </p>

    <%- include('footer') %>