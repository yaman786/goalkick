<script src="/socket.io/socket.io.js"></script>
<script>
    // Audio Context for sound
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playNotificationSound() {
        try {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        } catch (e) {
            console.error('Audio play failed', e);
        }
    }

    // Socket Connection
    const socket = io();

    socket.on('connect', () => {
        console.log('‚úÖ Connected to Socket Server');
        socket.emit('join_admin');
    });

    socket.on('ticket_sold', (data) => {
        console.log('üéüÔ∏è New Ticket Sold:', data);

        // Play Sound
        playNotificationSound();

        // Show Toast
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #22c55e;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease-out;
            font-family: 'Inter', sans-serif;
            min-width: 300px;
        `;

        toast.innerHTML = `
            <div style="font-size: 1.5rem;">üí∏</div>
            <div>
                <div style="font-weight: 700; font-size: 1rem;">New Ticket Request!</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">${data.count}x for ${data.match}</div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top:0.2rem;">${data.buyer}</div>
            </div>
        `;

        document.body.appendChild(toast);

        // Remove toast after 4 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-in forwards';
            setTimeout(() => toast.remove(), 300);
        }, 4000);

        // =============================================
        // REAL-TIME TABLE UPDATE (No page refresh!)
        // =============================================
        if (data.ticket && window.location.pathname.includes('/admin/tickets')) {
            const t = data.ticket;
            const tbody = document.querySelector('.admin-table tbody');
            if (tbody) {
                // Remove "No tickets found" row if exists
                const emptyRow = tbody.querySelector('td[colspan]');
                if (emptyRow) emptyRow.closest('tr').remove();

                // Create new row
                const newRow = document.createElement('tr');
                newRow.style.animation = 'fadeIn 0.5s ease-out';
                newRow.innerHTML = `
                    <td data-label="eSewa Ref">
                        <code style="color: #f59e0b; font-size: 0.75rem;">${t.payment_ref || '‚Äî'}</code>
                    </td>
                    <td data-label="Match">${t.team_home} vs ${t.team_away}</td>
                    <td data-label="Customer">
                        ${t.user_name}<br>
                        <small style="color: var(--admin-text-muted);">${t.user_phone}</small>
                    </td>
                    <td data-label="Qty">${t.quantity}</td>
                    <td data-label="Amount">Rs. ${Number(t.total_amount).toLocaleString()}</td>
                    <td data-label="Status">
                        <span class="badge badge-warning">Pending</span>
                    </td>
                    <td data-label="Used">‚Äî</td>
                    <td data-label="Actions">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; width: 100%;">
                            <form action="/admin/tickets/${t.id}/approve" method="POST" style="display: inline;">
                                <button type="submit" class="btn-admin btn-admin-sm btn-admin-primary">‚úì Approve</button>
                            </form>
                            <form action="/admin/tickets/${t.id}/reject" method="POST" style="display: inline;">
                                <button type="submit" class="btn-admin btn-admin-sm btn-admin-danger">‚úó</button>
                            </form>
                            <form action="/admin/tickets/${t.id}/delete" method="POST" style="display: inline;" 
                                onsubmit="return confirm('‚ö†Ô∏è Are you sure?');">
                                <button type="submit" class="btn-admin btn-admin-sm btn-admin-danger" title="Delete">üóëÔ∏è</button>
                            </form>
                        </div>
                    </td>
                `;

                // Insert at top of table
                tbody.insertBefore(newRow, tbody.firstChild);

                // Flash highlight effect
                newRow.style.background = 'rgba(34, 197, 94, 0.3)';
                setTimeout(() => {
                    newRow.style.transition = 'background 1s ease';
                    newRow.style.background = '';
                }, 2000);

                // Update ticket count text if exists
                const countText = document.querySelector('p[style*="margin-top: 1rem"]');
                if (countText) {
                    const currentCount = parseInt(countText.textContent.match(/\d+/)?.[0] || '0');
                    countText.textContent = `Showing ${currentCount + 1} ticket(s)`;
                }
            }
        }

        // =============================================
        // REAL-TIME DASHBOARD UPDATE (Pending Approvals)
        // =============================================
        if (data.ticket && (window.location.pathname === '/admin' || window.location.pathname === '/admin/')) {
            const t = data.ticket;
            // Find the Pending Approvals section (first admin-table on dashboard)
            const pendingSection = document.querySelector('.admin-section');
            if (pendingSection) {
                // Check if there's a "No tickets awaiting" message
                const emptyMsg = pendingSection.querySelector('p');
                if (emptyMsg && emptyMsg.textContent.includes('No tickets')) {
                    // Create table structure
                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'admin-table-wrapper';
                    tableWrapper.innerHTML = `
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>eSewa Ref</th>
                                    <th>Match</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    `;
                    emptyMsg.replaceWith(tableWrapper);
                }

                const tbody = pendingSection.querySelector('.admin-table tbody');
                if (tbody) {
                    const newRow = document.createElement('tr');
                    newRow.style.animation = 'fadeIn 0.5s ease-out';
                    newRow.innerHTML = `
                        <td data-label="eSewa Ref">
                            <code style="color: #f59e0b;">${t.payment_ref || '‚Äî'}</code>
                        </td>
                        <td data-label="Match">${t.team_home} vs ${t.team_away}</td>
                        <td data-label="Amount">Rs. ${Number(t.total_amount).toLocaleString()}</td>
                        <td data-label="Action">
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <form action="/admin/tickets/${t.id}/approve" method="POST" style="display: inline;">
                                    <button type="submit" class="btn-admin btn-admin-sm btn-admin-primary">‚úì</button>
                                </form>
                                <form action="/admin/tickets/${t.id}/reject" method="POST" style="display: inline;">
                                    <button type="submit" class="btn-admin btn-admin-sm btn-admin-danger">‚úó</button>
                                </form>
                            </div>
                        </td>
                    `;
                    tbody.insertBefore(newRow, tbody.firstChild);

                    // Flash highlight
                    newRow.style.background = 'rgba(34, 197, 94, 0.3)';
                    setTimeout(() => {
                        newRow.style.transition = 'background 1s ease';
                        newRow.style.background = '';
                    }, 2000);
                }
            }
        }
    });

    // Add keyframes for animations
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
</script>